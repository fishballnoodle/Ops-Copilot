<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ops Copilot Console</title>
  <style>
    :root{
      --bg:#0b1220; --panel:#0f1b2e; --panel2:#0d1728; --border:#1f3354;
      --text:#d7e2f1; --muted:#8aa1c2;
      --good:#3bd671; --warn:#f7c948; --bad:#ff5c5c; --accent:#44c2ff;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      --shadow: 0 10px 30px rgba(0,0,0,.25);
      --r: 14px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:var(--sans); color:var(--text); background:radial-gradient(1200px 900px at 20% 10%, #12284a 0%, var(--bg) 55%);
    }
    header{
      position:sticky; top:0; z-index:10;
      display:flex; align-items:center; justify-content:space-between;
      padding:14px 18px; border-bottom:1px solid var(--border);
      background:rgba(11,18,32,.82); backdrop-filter: blur(10px);
    }
    header .left{display:flex; gap:12px; align-items:baseline;}
    header h1{font-size:16px; margin:0; letter-spacing:.3px;}
    header .sub{color:var(--muted); font-size:12px;}
    header .right{display:flex; gap:10px; align-items:center;}
    .pill{
      border:1px solid var(--border); background:rgba(15,27,46,.8);
      padding:7px 10px; border-radius:999px; font-size:12px; color:var(--muted);
      box-shadow: var(--shadow);
    }
    .pill b{color:var(--text); font-weight:600}
    .btn{
      cursor:pointer; border:1px solid var(--border); background:rgba(15,27,46,.85);
      color:var(--text); padding:8px 10px; border-radius:10px; font-size:12px;
    }
    .btn:hover{border-color:#2c4a7a}
    .btn:active{transform:translateY(1px)}
    main{
      padding:16px; max-width:1400px; margin:0 auto;
      display:grid; grid-template-columns: 1.3fr .9fr; gap:16px;
    }
    .card{
      background:linear-gradient(180deg, rgba(15,27,46,.95), rgba(13,23,40,.92));
      border:1px solid var(--border);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card .hd{
      display:flex; align-items:center; justify-content:space-between;
      padding:12px 14px; border-bottom:1px solid var(--border);
      background:rgba(15,27,46,.8);
    }
    .card .hd .title{font-weight:700; font-size:13px; letter-spacing:.2px;}
    .card .bd{padding:12px 14px;}
    .muted{color:var(--muted)}
    .grid2{display:grid; grid-template-columns:1fr 1fr; gap:16px;}
    .stack{display:flex; flex-direction:column; gap:12px;}
    .row{display:flex; gap:10px; align-items:center;}
    .sep{height:1px; background:var(--border); margin:10px 0;}
    .tag{
      font-size:11px; padding:4px 8px; border-radius:999px; border:1px solid var(--border);
      color:var(--muted);
    }
    .lvl{font-weight:800; font-size:12px; padding:4px 8px; border-radius:999px;}
    .lvl.low{background:rgba(59,214,113,.12); color:var(--good); border:1px solid rgba(59,214,113,.35)}
    .lvl.med{background:rgba(247,201,72,.12); color:var(--warn); border:1px solid rgba(247,201,72,.35)}
    .lvl.high{background:rgba(255,92,92,.10); color:var(--bad); border:1px solid rgba(255,92,92,.35)}
    .mono{font-family:var(--mono);}
    .small{font-size:12px;}
    .tiny{font-size:11px;}
    .kpi{display:flex; gap:10px; flex-wrap:wrap;}
    .kpi .pill{box-shadow:none}
    .msgbox{
      border:1px solid var(--border);
      background:rgba(8,14,26,.55);
      border-radius:12px;
      padding:10px 10px;
    }
    .chat{
      display:flex; flex-direction:column; gap:10px; max-height:360px; overflow:auto; padding-right:6px;
    }
    .bubble{
      max-width:95%;
      border:1px solid var(--border);
      background:rgba(8,14,26,.55);
      border-radius:14px;
      padding:10px 10px;
      line-height:1.45;
      font-size:13px;
    }
    .bubble.me{align-self:flex-end; border-color:#2b4775; background:rgba(12,25,44,.65)}
    .bubble.ai{align-self:flex-start;}
    .inputrow{display:flex; gap:8px; margin-top:10px;}
    input[type="text"]{
      flex:1; padding:10px 10px; border-radius:12px; border:1px solid var(--border);
      background:rgba(8,14,26,.55); color:var(--text); outline:none;
    }
    input[type="text"]::placeholder{color:rgba(138,161,194,.7)}
    input[type="number"]{
      width:120px; padding:8px 10px; border-radius:12px; border:1px solid var(--border);
      background:rgba(8,14,26,.55); color:var(--text); outline:none;
      font-family:var(--mono); font-size:12px;
    }
    .quick{display:flex; gap:8px; flex-wrap:wrap;}
    .quick .btn{padding:7px 9px}
    .list{display:flex; flex-direction:column; gap:10px;}
    .item{
      cursor:pointer;
      border:1px solid var(--border);
      border-radius:12px;
      padding:10px 10px;
      background:rgba(8,14,26,.48);
    }
    .item:hover{border-color:#2c4a7a}
    .item.sel{border-color: var(--accent); box-shadow: 0 0 0 2px rgba(68,194,255,.15) inset;}
    .item .top{display:flex; align-items:center; justify-content:space-between; gap:10px;}
    .item .t{font-weight:700; font-size:13px;}
    .timeline{display:flex; flex-direction:column; gap:8px; max-height:260px; overflow:auto; padding-right:6px;}
    .tl{
      border-left:2px solid rgba(68,194,255,.25);
      padding-left:10px;
    }
    .tl .ts{color:var(--muted); font-size:11px;}
    .tl .note{font-size:12px; line-height:1.45;}
    .logbox{
      font-family:var(--mono);
      font-size:12px;
      line-height:1.45;
      max-height:260px;
      overflow:auto;
      padding-right:6px;
    }
    .logline{white-space:pre-wrap; border-bottom:1px dashed rgba(31,51,84,.55); padding:6px 0;}
    .logline .ts{color:var(--muted)}
    .logline .sevINFO{color:rgba(215,226,241,.7)}
    .logline .sevWARN{color:var(--warn)}
    .logline .sevERROR{color:var(--bad)}
    .rightcol{display:flex; flex-direction:column; gap:16px;}
    .analysis .summary{font-size:13px; line-height:1.5}
    .analysis .secTitle{font-size:12px; font-weight:800; letter-spacing:.2px; margin:12px 0 6px;}
    .analysis ul{margin:6px 0 0 16px; padding:0}
    .analysis li{margin:6px 0; font-size:12px; line-height:1.45}
    .footnote{color:var(--muted); font-size:11px; margin-top:8px}
    .badge{
      display:inline-flex; align-items:center; gap:6px;
      padding:4px 8px; border-radius:999px;
      border:1px solid var(--border); color:var(--muted); font-size:11px;
    }
    .dot{width:8px; height:8px; border-radius:999px; background:var(--muted)}
    .dot.ok{background:var(--good)}
    .dot.warn{background:var(--warn)}
    .dot.bad{background:var(--bad)}
  </style>
</head>
<body>
  <header>
    <div class="left">
      <h1>ğŸ¤– Ops Copilot Console</h1>
      <div class="sub">AI-first è¿ç»´æŒ‡æŒ¥ä¸­å¿ƒï¼ˆç»“è®ºä¸ºä¸»ï¼Œè¯æ®ä¸ºè¾…ï¼‰</div>
    </div>
    <div class="right">
      <div class="pill">API: <b id="apiBaseText"></b></div>
      <div class="pill">çŠ¶æ€: <b id="apiStatus">æœªçŸ¥</b></div>
      <div class="pill">TZ: <b id="tzText" class="mono"></b></div>
      <button class="btn" id="btnTZ">æ—¶åŒº</button>
      <button class="btn" id="btnRefresh">åˆ·æ–°</button>
    </div>
  </header>

  <main>
    <!-- LEFT: Copilot + Focus + Timeline -->
    <div class="card">
      <div class="hd">
        <div class="title">A Â· Ops Copilotï¼ˆä¸»è§†è§’ï¼‰</div>
        <div class="kpi">
          <span class="badge"><span class="dot" id="dotHealth"></span><span id="healthText">Health</span></span>
          <span class="badge">é€‰ä¸­äº‹ä»¶: <span id="selectedEventText" class="mono">æ— </span></span>
        </div>
      </div>
      <div class="bd">
        <div class="grid2">
          <!-- Chat -->
          <div class="stack">
            <div class="msgbox">
              <div class="row" style="justify-content:space-between;">
                <div class="small"><b>Copilot</b> <span class="muted">ï¼ˆè‡ªç”±èŠå¤© + æ¼”ç¤ºæŒ‰é’®ï¼‰</span></div>
                <div class="tag">ç»“æ„åŒ–è¾“å‡º</div>
              </div>

              <div class="quick" style="margin-top:10px;">
                <button class="btn" data-q="ç°åœ¨ç³»ç»ŸçŠ¶æ€æ€ä¹ˆæ ·ï¼Ÿ">ç°åœ¨çŠ¶æ€ï¼Ÿ</button>
                <button class="btn" data-q="å‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿä¸ºä»€ä¹ˆè¿™æ˜¯ä¸ªé—®é¢˜ï¼Ÿ">å‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿ</button>
                <button class="btn" data-q="ä¼šä¸ä¼šå½±å“ä¸šåŠ¡ï¼Ÿè¦ä¸è¦é©¬ä¸Šå¤„ç†ï¼Ÿ">å½±å“/ç´§æ€¥ï¼Ÿ</button>
                <button class="btn" data-q="æˆ‘ç°åœ¨åº”è¯¥åšä»€ä¹ˆï¼ŸæŒ‰ä¼˜å…ˆçº§ç»™æ­¥éª¤ã€‚">ä¸‹ä¸€æ­¥æ€ä¹ˆåšï¼Ÿ</button>
                <button class="btn" data-q="å¦‚æœæˆ‘æš‚æ—¶ä¸å¤„ç†ï¼Œä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ">ä¸å¤„ç†ä¼šæ€æ ·ï¼Ÿ</button>
              </div>

              <div class="sep"></div>

              <div id="chat" class="chat"></div>

              <div class="inputrow">
                <input id="chatInput" type="text" placeholder="è‡ªç”±æé—®ï¼šæ¯”å¦‚â€œè¿™æ¡ MAC æ¼‚ç§»ä¸ºä»€ä¹ˆæ˜¯ HIGHï¼Ÿâ€" />
                <button class="btn" id="btnSend">å‘é€</button>
              </div>

              <div class="footnote">
                Tipï¼šæŒ‰é’®æ˜¯ä¸ºäº†æ¼”ç¤ºç¨³å®šï¼›è‡ªç”±è¾“å…¥èƒ½éªŒè¯â€œæ˜¯ä¸æ˜¯ LLM çœŸåœ¨å›ç­”â€ï¼ˆçœ‹å³ä¾§ token é¢æ¿ä¼šä¸ä¼šå¢é•¿ï¼‰ã€‚
              </div>
            </div>
          </div>

          <!-- Focus + Timeline -->
          <div class="stack">
            <div class="card" style="margin:0;">
              <div class="hd">
                <div class="title">C Â· å…³æ³¨ç„¦ç‚¹ï¼ˆTop 3ï¼‰</div>
                <div class="muted tiny">â€œä½ ç°åœ¨æœ€è¯¥å…³å¿ƒçš„â€</div>
              </div>
              <div class="bd">
                <div id="focusList" class="list"></div>
              </div>
            </div>

            <div class="card" style="margin:0;">
              <div class="hd">
                <div class="title">B Â· äº‹ä»¶æ—¶é—´çº¿ï¼ˆNarrativeï¼‰</div>
                <div class="muted tiny">â€œAI å¦‚ä½•ç†è§£äº‹ä»¶â€</div>
              </div>
              <div class="bd">
                <div id="timeline" class="timeline"></div>
                <div class="footnote">é€‰ä¸­æŸä¸ªäº‹ä»¶åè‡ªåŠ¨åˆ·æ–°ã€‚</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- RIGHT: Analysis + LLM Panel + Evidence -->
    <div class="rightcol">
      <div class="card analysis">
        <div class="hd">
          <div class="title">AI åˆ†æé¢æ¿ï¼ˆç»“è®º â†’ é£é™© â†’ æ ¹å›  â†’ åŠ¨ä½œï¼‰</div>
          <div id="riskBadge"></div>
        </div>
        <div class="bd">
          <div class="summary" id="summaryText" class="small muted">æš‚æ— åˆ†æã€‚å…ˆç‚¹ä¸€ä¸ªäº‹ä»¶æˆ–åœ¨ Copilot é—®ä¸€å¥ã€‚</div>

          <div class="secTitle">é£é™©è¯„ä¼°</div>
          <div id="riskText" class="small muted">-</div>

          <div class="secTitle">å¯èƒ½åŸå› </div>
          <ul id="causes"></ul>

          <div class="secTitle">å»ºè®®åŠ¨ä½œ</div>
          <ul id="actions"></ul>

          <div class="secTitle">è¯æ®å¼•ç”¨</div>
          <div id="evidenceRefs" class="tiny muted">-</div>
        </div>
      </div>

      <!-- LLM Token / Cost é¢æ¿ -->
      <div class="card">
        <div class="hd">
          <div class="title">LLM Token & æˆæœ¬é¢æ¿ï¼ˆè¿‡å» 1 å°æ—¶ï¼‰</div>
          <div class="muted tiny">â€œæŒ‰ action/endpoint çœ‹åˆ°åº•æ˜¯è°åœ¨çƒ§é’±â€</div>
        </div>
        <div class="bd">
          <div class="kpi" style="margin-bottom:10px;">
            <span class="pill">Calls: <b id="llmCalls">0</b></span>
            <span class="pill">Errors: <b id="llmErrors">0</b></span>
            <span class="pill">Tokens: <b id="llmTokens">0</b></span>
            <span class="pill">Avg Lat: <b id="llmAvgLat">0</b> ms</span>
            <span class="pill">Est Cost: <b id="llmCostTotal">$0.0000</b></span>
          </div>

          <div class="msgbox" style="margin-bottom:10px;">
            <div class="row" style="justify-content:space-between;">
              <div class="small"><b>ä»·æ ¼è®¾ç½®ï¼ˆ$ / 1M tokensï¼‰</b> <span class="muted tiny">ä¿å­˜åˆ°æµè§ˆå™¨</span></div>
              <button class="btn" id="btnSavePrice">ä¿å­˜</button>
            </div>
            <div class="row tiny muted" style="margin-top:8px; flex-wrap:wrap;">
              <span>Input:</span> <input type="number" step="0.0001" id="priceIn" />
              <span>Output:</span> <input type="number" step="0.0001" id="priceOut" />
              <span>Blend(æ— æ‹†åˆ†æ—¶ç”¨):</span> <input type="number" step="0.0001" id="priceBlend" />
              <span class="muted tiny">(å¦‚æœåç«¯ä¸ç»™ prompt/compl tokensï¼Œå°±ç”¨ Blend * total_tokens)</span>
            </div>
          </div>

          <div class="sep"></div>

          <div class="grid2" style="grid-template-columns:1fr 1fr;">
            <div>
              <div class="small"><b>By Action</b> <span class="muted tiny">(top 8)</span></div>
              <div id="llmByAction" class="tiny muted" style="margin-top:8px;"></div>
            </div>
            <div>
              <div class="small"><b>By Endpoint</b> <span class="muted tiny">(top 8)</span></div>
              <div id="llmByEndpoint" class="tiny muted" style="margin-top:8px;"></div>
            </div>
          </div>

          <div class="sep"></div>

          <div class="row" style="justify-content:space-between; align-items:baseline;">
            <div class="small"><b>Recent Calls</b> <span class="muted tiny">(latest 20)</span></div>
            <div class="tag mono" id="llmUpdatedAt">-</div>
          </div>

          <div id="llmRecent" class="logbox" style="max-height:240px; margin-top:8px;"></div>

          <div class="footnote">
            è¯´æ˜ï¼šå¦‚æœä½ ç‚¹æŒ‰é’®/å‘é€èŠå¤©åï¼Œè¿™é‡Œ calls/tokens å¢é•¿ä¸” recent å‡ºç°æ–°è®°å½•ï¼Œå°±èƒ½è¯æ˜æ˜¯ LLM è°ƒç”¨è€Œéé¢„åˆ¶å›ç­”ã€‚
          </div>
        </div>
      </div>

      <div class="card">
        <div class="hd">
          <div class="title">è¯æ®å±‚ï¼ˆäº‹ä»¶/æ—¥å¿—æµï¼‰</div>
          <div class="muted tiny">â€œæ•°æ®ç»™ AI ç”¨ï¼Œäººåªåœ¨éœ€è¦æ—¶çœ‹è¯æ®â€</div>
        </div>
        <div class="bd">
          <div class="row" style="justify-content:space-between;">
            <div class="small"><b>æœ€æ–°äº‹ä»¶ï¼ˆç”¨äºçœŸå®æ„Ÿï¼‰</b></div>
            <div class="tag mono" id="eventCount">0</div>
          </div>
          <div class="sep"></div>
          <div id="logbox" class="logbox"></div>
          <div class="footnote">é»˜è®¤æ¯ 2 ç§’åˆ·æ–°ä¸€æ¬¡ï¼ˆå¯æ”¹ï¼‰ã€‚</div>
        </div>
      </div>
    </div>
  </main>

<script>
(() => {
  // === Config ===
  const API_BASE = localStorage.getItem("OPS_API_BASE") || "http://127.0.0.1:8000";
  const REFRESH_MS = 2000;
  const WINDOW_S = 3600; // âœ… è¿‡å» 1 å°æ—¶
  const DEFAULT_TZ = "Asia/Shanghai"; // ä½ ä¹Ÿå¯ä»¥æ”¹æˆ Asia/Singapore ç­‰
  const TZ_KEY = "OPS_TZ";
  const TZ = localStorage.getItem(TZ_KEY) || DEFAULT_TZ;

  // === DOM ===
  const apiBaseText = document.getElementById("apiBaseText");
  const apiStatus = document.getElementById("apiStatus");
  const btnRefresh = document.getElementById("btnRefresh");
  const tzText = document.getElementById("tzText");
  const btnTZ = document.getElementById("btnTZ");
  const dotHealth = document.getElementById("dotHealth");
  const healthText = document.getElementById("healthText");
  const selectedEventText = document.getElementById("selectedEventText");

  const chat = document.getElementById("chat");
  const chatInput = document.getElementById("chatInput");
  const btnSend = document.getElementById("btnSend");

  const focusList = document.getElementById("focusList");
  const timeline = document.getElementById("timeline");

  const riskBadge = document.getElementById("riskBadge");
  const summaryText = document.getElementById("summaryText");
  const riskText = document.getElementById("riskText");
  const causes = document.getElementById("causes");
  const actions = document.getElementById("actions");
  const evidenceRefs = document.getElementById("evidenceRefs");

  const logbox = document.getElementById("logbox");
  const eventCount = document.getElementById("eventCount");

  // === LLM Panel DOM ===
  const llmCalls = document.getElementById("llmCalls");
  const llmErrors = document.getElementById("llmErrors");
  const llmTokens = document.getElementById("llmTokens");
  const llmAvgLat = document.getElementById("llmAvgLat");
  const llmCostTotal = document.getElementById("llmCostTotal");
  const llmByAction = document.getElementById("llmByAction");
  const llmByEndpoint = document.getElementById("llmByEndpoint");
  const llmRecent = document.getElementById("llmRecent");
  const llmUpdatedAt = document.getElementById("llmUpdatedAt");

  // price inputs
  const priceIn = document.getElementById("priceIn");
  const priceOut = document.getElementById("priceOut");
  const priceBlend = document.getElementById("priceBlend");
  const btnSavePrice = document.getElementById("btnSavePrice");

  apiBaseText.textContent = API_BASE;

  if(tzText) tzText.textContent = TZ;

  // === State ===
  let selectedEventId = null;
  let lastEvents = [];

  // === Helpers ===
  function lvlClass(lvl){
    if(!lvl) return "low";
    const x = String(lvl).toUpperCase();
    if(x === "HIGH") return "high";
    if(x === "MEDIUM") return "med";
    return "low";
  }
  function lvlLabel(lvl){
    const x = String(lvl||"LOW").toUpperCase();
    if(x === "HIGH") return "HIGH";
    if(x === "MEDIUM") return "MEDIUM";
    return "LOW";
  }

  function setHealth(ok, text){
    apiStatus.textContent = ok ? "OK" : "DOWN";
    dotHealth.className = "dot " + (ok ? "ok" : "bad");
    healthText.textContent = text || (ok ? "Healthy" : "Unreachable");
  }

  async function api(path, opts={}){
    const url = API_BASE + path;
    const res = await fetch(url, {
      headers: {"Content-Type":"application/json"},
      ...opts
    });
    if(!res.ok){
      const t = await res.text().catch(()=> "");
      throw new Error(`HTTP ${res.status} ${path} ${t}`);
    }
    return res.json();
  }

  function pushBubble(text, who="ai"){
    const div = document.createElement("div");
    div.className = "bubble " + (who === "me" ? "me" : "ai");
    div.textContent = text;
    chat.appendChild(div);
    chat.scrollTop = chat.scrollHeight;
  }

  function escapeHtml(s){
    return String(s ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  // === Timezone formatting ===
  function _toDate(ts){
    if(!ts) return null;
    const d = new Date(ts);
    if(isNaN(d.getTime())) return null;
    return d;
  }
  function fmtTs(ts){
    const d = _toDate(ts);
    if(!d) return String(ts || "");
    try{
      const fmt = new Intl.DateTimeFormat("zh-CN", {
        timeZone: TZ,
        year:"numeric", month:"2-digit", day:"2-digit",
        hour:"2-digit", minute:"2-digit", second:"2-digit",
        hour12:false
      });
      return fmt.format(d);
    }catch(e){
      return d.toLocaleString();
    }
  }

  function renderFocus(items){
    focusList.innerHTML = "";
    if(!items || items.length === 0){
      focusList.innerHTML = `<div class="muted small">æš‚æ— äº‹ä»¶ã€‚å…ˆè·‘ feeder æˆ–æ‰‹åŠ¨ ingestã€‚</div>`;
      return;
    }
    for(const it of items){
      const div = document.createElement("div");
      div.className = "item" + (it.event_id === selectedEventId ? " sel" : "");
      div.innerHTML = `
        <div class="top">
          <div class="t">${escapeHtml(it.title)}</div>
          <span class="lvl ${lvlClass(it.risk_level)}">${lvlLabel(it.risk_level)}</span>
        </div>
        <div class="muted tiny" style="margin-top:6px;">${escapeHtml(it.one_line || "")}</div>
        <div class="muted tiny mono" style="margin-top:6px;">${escapeHtml(it.event_id)}</div>
      `;
      div.onclick = () => selectEvent(it.event_id);
      focusList.appendChild(div);
    }
  }

  function renderTimeline(items){
    timeline.innerHTML = "";
    if(!items || items.length === 0){
      timeline.innerHTML = `<div class="muted small">æš‚æ— æ—¶é—´çº¿ã€‚è¯·å…ˆé€‰ä¸­äº‹ä»¶ã€‚</div>`;
      return;
    }
    for(const t of items){
      const div = document.createElement("div");
      div.className = "tl";
      div.innerHTML = `
        <div class="ts mono">${escapeHtml(fmtTs(t.ts))}</div>
        <div class="note">${escapeHtml(t.note)}</div>
      `;
      timeline.appendChild(div);
    }
    timeline.scrollTop = timeline.scrollHeight;
  }

  function renderAnalysis(a){
    if(!a){
      riskBadge.innerHTML = "";
      summaryText.textContent = "æš‚æ— åˆ†æã€‚å…ˆç‚¹ä¸€ä¸ªäº‹ä»¶æˆ–åœ¨ Copilot é—®ä¸€å¥ã€‚";
      riskText.textContent = "-";
      causes.innerHTML = "";
      actions.innerHTML = "";
      evidenceRefs.textContent = "-";
      return;
    }
    const lvl = a.risk?.level || "LOW";
    riskBadge.innerHTML = `<span class="lvl ${lvlClass(lvl)}">${lvlLabel(lvl)}</span>`;
    summaryText.textContent = a.summary || "";
    riskText.textContent = `${lvlLabel(lvl)} Â· ç½®ä¿¡åº¦ ${(a.risk?.confidence ?? 0).toFixed(2)} Â· å½±å“ï¼š${a.risk?.impact || "-"} Â· æ‰©æ•£ï¼š${a.risk?.spread || "-"}`;

    causes.innerHTML = "";
    (a.possible_causes || []).forEach(c => {
      const li = document.createElement("li");
      li.textContent = `${c.rank}. ${c.cause}ï¼ˆ${(c.confidence ?? 0).toFixed(2)}ï¼‰`;
      causes.appendChild(li);
    });

    actions.innerHTML = "";
    (a.actions || []).forEach(x => {
      const li = document.createElement("li");
      li.textContent = `${x.priority}. ${x.action} â€”â€” ${x.why}`;
      actions.appendChild(li);
    });

    const refs = (a.evidence_refs || []).map(r => {
      if(r.type === "log") return `log:${r.id || "-"}`;
      return `metric:${r.name || "-"}@${r.ts || "-"}`;
    });
    evidenceRefs.textContent = refs.length ? refs.join(" Â· ") : "-";
  }

  function renderLogBox(events){
    logbox.innerHTML = "";
    eventCount.textContent = String(events.length);
    for(const e of events){
      const raw = e?.raw?.message || e?.raw?.payload?.msg || "";
      const ts = e.ts || "";
      const sev = e.severity_hint || "INFO";
      const line = document.createElement("div");
      line.className = "logline";
      line.innerHTML = `<span class="ts">${escapeHtml(fmtTs(ts))}</span>  <span class="sev${escapeHtml(sev)}">${escapeHtml(sev)}</span>  ${escapeHtml(raw || e.title || "")}`;
      logbox.appendChild(line);
    }
  }

  async function selectEvent(eventId){
    selectedEventId = eventId;
    selectedEventText.textContent = eventId ? eventId : "æ— ";

    try{
      const tl = await api(`/api/incidents/${encodeURIComponent(eventId)}/timeline`);
      renderTimeline(tl.timeline || []);
    }catch(e){
      renderTimeline([]);
    }

    try{
      const a = await api(`/api/copilot/analyze`, {
        method:"POST",
        body: JSON.stringify({ event_id: eventId, question:"what_happened", context:{} })
      });
      renderAnalysis(a);
    }catch(e){
      renderAnalysis(null);
    }

    await refreshFocus();
  }

  async function refreshHealth(){
    try{
      const h = await api("/api/health");
      setHealth(true, `LLM:${h.llm} v${h.version}`);
    }catch(e){
      setHealth(false, "API unreachable");
    }
  }

  async function refreshFocus(){
    try{
      const f = await api("/api/focus?top=3");
      renderFocus(f.items || []);
      if(!selectedEventId && f.items && f.items.length){
        await selectEvent(f.items[0].event_id);
      }
    }catch(e){
      renderFocus([]);
    }
  }

  async function refreshEvents(){
    try{
      const evts = await api("/api/events?limit=30");
      lastEvents = evts || [];
      renderLogBox(lastEvents);
    }catch(e){
      renderLogBox([]);
    }
  }

  // =========================
  // Pricing + Cost Estimation
  // =========================
  const PRICE_KEY = "OPS_LLM_PRICE";
  function loadPrice(){
    const raw = localStorage.getItem(PRICE_KEY);
    let p = { in_per_1m: 0.0, out_per_1m: 0.0, blend_per_1m: 0.0 };
    try{
      if(raw){
        const j = JSON.parse(raw);
        p.in_per_1m = Number(j.in_per_1m ?? p.in_per_1m);
        p.out_per_1m = Number(j.out_per_1m ?? p.out_per_1m);
        p.blend_per_1m = Number(j.blend_per_1m ?? p.blend_per_1m);
      }
    }catch(e){}
    return p;
  }
  function savePrice(p){
    localStorage.setItem(PRICE_KEY, JSON.stringify(p));
  }
  function applyPriceToInputs(p){
    priceIn.value = String(p.in_per_1m ?? 0);
    priceOut.value = String(p.out_per_1m ?? 0);
    priceBlend.value = String(p.blend_per_1m ?? 0);
  }
  function readPriceFromInputs(){
    return {
      in_per_1m: Number(priceIn.value || 0),
      out_per_1m: Number(priceOut.value || 0),
      blend_per_1m: Number(priceBlend.value || 0),
    };
  }

  // âœ… æ–°å¢ï¼šå¦‚æœ blend=0 ä½†å¡«äº† in/outï¼Œåˆ™è‡ªåŠ¨ç”¨å‡å€¼å½“ blendï¼ˆä»…ç”¨äºè®¡ç®—ï¼‰
  function effectivePrice(p){
    const inP = Number(p.in_per_1m || 0);
    const outP = Number(p.out_per_1m || 0);
    let blend = Number(p.blend_per_1m || 0);
    if((!blend || blend <= 0) && (inP > 0 || outP > 0)){
      const denom = (inP > 0 && outP > 0) ? 2 : 1;
      blend = ((inP > 0 ? inP : 0) + (outP > 0 ? outP : 0)) / denom;
    }
    return { in_per_1m: inP, out_per_1m: outP, blend_per_1m: blend };
  }

  function estimateCostUSD(row, price){
    const pt = Number(row.prompt_tokens ?? 0);
    const ct = Number(row.completion_tokens ?? 0);
    const tt = Number(row.total_tokens ?? (pt + ct) ?? 0);

    // æ‹†åˆ†ä¼˜å…ˆ
    if((pt > 0 || ct > 0) && (price.in_per_1m > 0 || price.out_per_1m > 0)){
      return (pt/1e6) * price.in_per_1m + (ct/1e6) * price.out_per_1m;
    }
    // fallback ç”¨ blend
    return (tt/1e6) * (price.blend_per_1m || 0);
  }

  function formatUSD(x){
    const n = Number(x || 0);
    return `$${n.toFixed(4)}`;
  }

  // =========================
  // LLM Panel Render
  // =========================
  function renderKVList(container, obj, topN=8, price=null){
    if(!container) return;
    if(!obj || typeof obj !== "object"){
      container.innerHTML = `<div class="muted tiny">-</div>`;
      return;
    }

    const rows = Object.entries(obj)
      .map(([k,v]) => {
        const calls = v.calls ?? 0;
        const tokens = v.tokens ?? 0;
        const err = v.errors ?? 0;
        const lat = v.avg_latency_ms ?? 0;
        let cost = 0;
        if(price){
          // summary çš„ by_action/by_endpoint é€šå¸¸åªæœ‰ tokens â†’ ç”¨æœ‰æ•ˆ blend ä¼°
          cost = (Number(tokens)/1e6) * (price.blend_per_1m || 0);
        }
        return {k, calls, tokens, err, lat, cost};
      })
      .sort((a,b) => (b.cost - a.cost) || (b.tokens - a.tokens) || (b.calls - a.calls))
      .slice(0, topN);

    if(rows.length === 0){
      container.innerHTML = `<div class="muted tiny">-</div>`;
      return;
    }

    container.innerHTML = rows.map(r => `
      <div class="row" style="justify-content:space-between; gap:10px; padding:4px 0; border-bottom:1px dashed rgba(31,51,84,.35);">
        <div class="mono" style="max-width:55%; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${escapeHtml(r.k)}</div>
        <div class="mono" style="text-align:right;">
          <span class="muted">calls</span> ${r.calls}
          Â· <span class="muted">tok</span> ${r.tokens}
          Â· <span class="muted">err</span> ${r.err}
          Â· <span class="muted">ms</span> ${r.lat}
          ${price ? `Â· <span class="muted">cost</span> ${formatUSD(r.cost)}` : ``}
        </div>
      </div>
    `).join("");
  }

  function renderRecentCalls(items, price){
    if(!llmRecent) return;
    llmRecent.innerHTML = "";
    if(!items || !items.length){
      llmRecent.innerHTML = `<div class="muted tiny">æš‚æ—  LLM è°ƒç”¨è®°å½•ï¼ˆæœ€è¿‘ 1 å°æ—¶ï¼‰ã€‚</div>`;
      return;
    }

    const show = items.slice(0, 20);
    for(const r of show){
      const ok = r.ok ? "OK" : "ERR";
      const sevClass = r.ok ? "sevINFO" : "sevERROR";
      const est = estimateCostUSD(r, price);

      const pt = Number(r.prompt_tokens ?? 0);
      const ct = Number(r.completion_tokens ?? 0);
      const tt = Number(r.total_tokens ?? 0);

      const line = document.createElement("div");
      line.className = "logline";
      line.innerHTML = `
        <span class="ts">${escapeHtml(fmtTs(r.ts || ""))}</span>
        <span class="${sevClass}" style="margin-left:8px;">${ok}</span>
        <span class="muted" style="margin-left:8px;">tok</span> <span class="mono">${escapeHtml(tt)}</span>
        <span class="muted" style="margin-left:8px;">ms</span> <span class="mono">${escapeHtml(r.latency_ms ?? 0)}</span>
        <span class="muted" style="margin-left:8px;">est</span> <span class="mono">${escapeHtml(formatUSD(est))}</span>
        <br/>
        <span class="muted">split</span> <span class="mono">in:${escapeHtml(pt)} out:${escapeHtml(ct)}</span>
        <span class="muted" style="margin-left:10px;">action</span> <span class="mono">${escapeHtml(r.action || "-")}</span>
        <br/>
        <span class="muted">endpoint</span> <span class="mono">${escapeHtml(r.endpoint || "-")}</span>
        <span class="muted" style="margin-left:10px;">event</span> <span class="mono">${escapeHtml(r.event_id || "-")}</span>
        <span class="muted" style="margin-left:10px;">intent</span> <span class="mono">${escapeHtml(r.intent || "-")}</span>
        ${r.error ? `<br/><span class="sevERROR">${escapeHtml(r.error)}</span>` : ``}
      `;
      llmRecent.appendChild(line);
    }
  }

  async function refreshLLMPanel(){
    // ä»·æ ¼ï¼ˆæ¯æ¬¡åˆ·æ–°éƒ½è¯»ä¸€æ¬¡ï¼Œä¿è¯ä½ æ”¹äº†ç«‹å³ç”Ÿæ•ˆï¼‰
    const p0 = loadPrice();
    const price = effectivePrice(p0);

    try{
      // å…ˆå– summaryï¼ˆç”¨äº calls/tokens/lat ä»¥åŠ by_action/by_endpointï¼‰
      const sum = await api(`/api/llm/summary?window_s=${WINDOW_S}`);
      const s = sum?.summary || {};

      if(llmCalls) llmCalls.textContent = String(s.calls ?? 0);
      if(llmErrors) llmErrors.textContent = String(s.errors ?? 0);
      if(llmTokens) llmTokens.textContent = String(s.total_tokens ?? 0);
      if(llmAvgLat) llmAvgLat.textContent = String(s.avg_latency_ms ?? 0);

      renderKVList(llmByAction, s.by_action || {}, 8, price);
      renderKVList(llmByEndpoint, s.by_endpoint || {}, 8, price);

      // âœ… å†å– usageï¼šç”¨æœ€è¿‘æ˜ç»†é€æ¡ä¼°ç®—â€œæ€»æˆæœ¬â€ï¼ˆæ›´å‡†ï¼‰
      const usage = await api(`/api/llm/usage?window_s=${WINDOW_S}&limit=200`);
      const items = usage?.items || [];

      renderRecentCalls(items, price);

      let totalCost = 0;
      if(items && items.length){
        for(const r of items){
          totalCost += estimateCostUSD(r, price);
        }
      }else{
        // usage æ²¡æ•°æ®æ—¶ fallbackï¼šsummary.total_tokens * blend
        const totalTok = Number(s.total_tokens ?? 0);
        totalCost = (totalTok/1e6) * (price.blend_per_1m || 0);
      }
      if(llmCostTotal) llmCostTotal.textContent = formatUSD(totalCost);

      if(llmUpdatedAt) llmUpdatedAt.textContent = escapeHtml(fmtTs(sum.generated_at || usage.generated_at || "-"));
    }catch(e){
      if(llmUpdatedAt) llmUpdatedAt.textContent = "LLM é¢æ¿ä¸å¯ç”¨";
    }
  }

  // =========================
  // Copilot Chat
  // =========================
  async function sendChat(text){
    const msg = text.trim();
    if(!msg) return;
    pushBubble(msg, "me");

    try{
      const payload = {
        session_id: "demo",
        message: msg,
        context: { selected_event_id: selectedEventId }
      };
      const r = await api("/api/copilot/chat", { method:"POST", body: JSON.stringify(payload) });

      pushBubble(r.reply || "(no reply)", "ai");

      await refreshFocus();

      if(r.analysis) renderAnalysis(r.analysis);
    }catch(e){
      pushBubble("è°ƒç”¨ Copilot å¤±è´¥ï¼šè¯·ç¡®è®¤åç«¯å·²å¯åŠ¨ï¼Œå¹¶å…è®¸ CORSã€‚", "ai");
    }
  }

  // === Wiring ===
  btnSend.onclick = () => { sendChat(chatInput.value); chatInput.value=""; chatInput.focus(); };
  chatInput.addEventListener("keydown", (e) => {
    if(e.key === "Enter"){ btnSend.click(); }
  });

  document.querySelectorAll("[data-q]").forEach(btn => {
    btn.onclick = () => sendChat(btn.getAttribute("data-q"));
  });

  btnRefresh.onclick = async () => {
    await refreshAll(true);
  };

  // åˆ‡æ¢æ—¶åŒºï¼ˆä¿å­˜åˆ°æµè§ˆå™¨ï¼‰
  if(btnTZ){
    btnTZ.onclick = () => {
      const cur = localStorage.getItem(TZ_KEY) || DEFAULT_TZ;
      const nz = prompt("è¾“å…¥è¦æ˜¾ç¤ºçš„æ—¶åŒºï¼ˆIANAï¼‰ï¼Œä¾‹å¦‚ï¼šAsia/Shanghai / Asia/Singapore / UTC", cur);
      if(nz && nz.trim()){
        localStorage.setItem(TZ_KEY, nz.trim());
        location.reload();
      }
    };
  }

  // ä¿å­˜ä»·æ ¼
  btnSavePrice.onclick = () => {
    const p = readPriceFromInputs();
    savePrice(p);

    // âœ… æç¤ºâ€œæœ‰æ•ˆ blendâ€
    const eff = effectivePrice(p);
    pushBubble(
      `å·²ä¿å­˜ä»·æ ¼ï¼šin=${eff.in_per_1m}/1M, out=${eff.out_per_1m}/1M, blend=${eff.blend_per_1m}/1Mï¼ˆè®¡ç®—ç”¨ï¼‰`,
      "ai"
    );
  };

  async function refreshAll(force=false){
    await refreshHealth();
    await refreshEvents();
    await refreshFocus();
    await refreshLLMPanel();
  }

  // === Init ===
  (async () => {
    // é»˜è®¤ä»·æ ¼ï¼ˆä½ å¯ä»¥è‡ªå·±æ”¹ï¼‰
    const p = loadPrice();
    applyPriceToInputs(p);

    pushBubble("æˆ‘å·²ç»å¸®ä½ çœ‹å®Œç³»ç»Ÿäº†ã€‚ä½ å¯ä»¥ç‚¹æŒ‰é’®æˆ–è‡ªç”±æé—®ã€‚", "ai");
    await refreshAll(true);
    setInterval(() => refreshAll(false), REFRESH_MS);
  })();
})();
</script>
</body>
</html>