<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ops Copilot Console</title>
  <style>
    :root{
      --bg:#0b1220; --panel:#0f1b2e; --panel2:#0d1728; --border:#1f3354;
      --text:#d7e2f1; --muted:#8aa1c2;
      --good:#3bd671; --warn:#f7c948; --bad:#ff5c5c; --accent:#44c2ff;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      --shadow: 0 10px 30px rgba(0,0,0,.25);
      --r: 14px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:var(--sans); color:var(--text); background:radial-gradient(1200px 900px at 20% 10%, #12284a 0%, var(--bg) 55%);
    }
    header{
      position:sticky; top:0; z-index:10;
      display:flex; align-items:center; justify-content:space-between;
      padding:14px 18px; border-bottom:1px solid var(--border);
      background:rgba(11,18,32,.82); backdrop-filter: blur(10px);
    }
    header .left{display:flex; gap:12px; align-items:baseline;}
    header h1{font-size:16px; margin:0; letter-spacing:.3px;}
    header .sub{color:var(--muted); font-size:12px;}
    header .right{display:flex; gap:10px; align-items:center;}
    .pill{
      border:1px solid var(--border); background:rgba(15,27,46,.8);
      padding:7px 10px; border-radius:999px; font-size:12px; color:var(--muted);
      box-shadow: var(--shadow);
    }
    .pill b{color:var(--text); font-weight:600}
    .btn{
      cursor:pointer; border:1px solid var(--border); background:rgba(15,27,46,.85);
      color:var(--text); padding:8px 10px; border-radius:10px; font-size:12px;
    }
    .btn:hover{border-color:#2c4a7a}
    .btn:active{transform:translateY(1px)}
    main{
      padding:16px; max-width:1400px; margin:0 auto;
      display:grid; grid-template-columns: 1.3fr .9fr; gap:16px;
    }
    .card{
      background:linear-gradient(180deg, rgba(15,27,46,.95), rgba(13,23,40,.92));
      border:1px solid var(--border);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card .hd{
      display:flex; align-items:center; justify-content:space-between;
      padding:12px 14px; border-bottom:1px solid var(--border);
      background:rgba(15,27,46,.8);
    }
    .card .hd .title{font-weight:700; font-size:13px; letter-spacing:.2px;}
    .card .bd{padding:12px 14px;}
    .muted{color:var(--muted)}
    .grid2{display:grid; grid-template-columns:1fr 1fr; gap:16px;}
    .stack{display:flex; flex-direction:column; gap:12px;}
    .row{display:flex; gap:10px; align-items:center;}
    .sep{height:1px; background:var(--border); margin:10px 0;}
    .tag{
      font-size:11px; padding:4px 8px; border-radius:999px; border:1px solid var(--border);
      color:var(--muted);
    }
    .lvl{font-weight:800; font-size:12px; padding:4px 8px; border-radius:999px;}
    .lvl.low{background:rgba(59,214,113,.12); color:var(--good); border:1px solid rgba(59,214,113,.35)}
    .lvl.med{background:rgba(247,201,72,.12); color:var(--warn); border:1px solid rgba(247,201,72,.35)}
    .lvl.high{background:rgba(255,92,92,.10); color:var(--bad); border:1px solid rgba(255,92,92,.35)}
    .mono{font-family:var(--mono);}
    .small{font-size:12px;}
    .tiny{font-size:11px;}
    .kpi{display:flex; gap:10px; flex-wrap:wrap;}
    .kpi .pill{box-shadow:none}
    .msgbox{
      border:1px solid var(--border);
      background:rgba(8,14,26,.55);
      border-radius:12px;
      padding:10px 10px;
    }
    .chat{
      display:flex; flex-direction:column; gap:10px; max-height:360px; overflow:auto; padding-right:6px;
    }
    .bubble{
      max-width:95%;
      border:1px solid var(--border);
      background:rgba(8,14,26,.55);
      border-radius:14px;
      padding:10px 10px;
      line-height:1.45;
      font-size:13px;
    }
    .bubble.me{align-self:flex-end; border-color:#2b4775; background:rgba(12,25,44,.65)}
    .bubble.ai{align-self:flex-start;}
    .inputrow{display:flex; gap:8px; margin-top:10px;}
    input[type="text"]{
      flex:1; padding:10px 10px; border-radius:12px; border:1px solid var(--border);
      background:rgba(8,14,26,.55); color:var(--text); outline:none;
    }
    input[type="text"]::placeholder{color:rgba(138,161,194,.7)}
    .quick{display:flex; gap:8px; flex-wrap:wrap;}
    .quick .btn{padding:7px 9px}
    .list{display:flex; flex-direction:column; gap:10px;}
    .item{
      cursor:pointer;
      border:1px solid var(--border);
      border-radius:12px;
      padding:10px 10px;
      background:rgba(8,14,26,.48);
    }
    .item:hover{border-color:#2c4a7a}
    .item.sel{border-color: var(--accent); box-shadow: 0 0 0 2px rgba(68,194,255,.15) inset;}
    .item .top{display:flex; align-items:center; justify-content:space-between; gap:10px;}
    .item .t{font-weight:700; font-size:13px;}
    .timeline{display:flex; flex-direction:column; gap:8px; max-height:260px; overflow:auto; padding-right:6px;}
    .tl{
      border-left:2px solid rgba(68,194,255,.25);
      padding-left:10px;
    }
    .tl .ts{color:var(--muted); font-size:11px;}
    .tl .note{font-size:12px; line-height:1.45;}
    .logbox{
      font-family:var(--mono);
      font-size:12px;
      line-height:1.45;
      max-height:260px;
      overflow:auto;
      padding-right:6px;
    }
    .logline{white-space:pre-wrap; border-bottom:1px dashed rgba(31,51,84,.55); padding:6px 0;}
    .logline .ts{color:var(--muted)}
    .logline .sevINFO{color:rgba(215,226,241,.7)}
    .logline .sevWARN{color:var(--warn)}
    .logline .sevERROR{color:var(--bad)}
    .rightcol{display:flex; flex-direction:column; gap:16px;}
    .analysis .summary{font-size:13px; line-height:1.5}
    .analysis .secTitle{font-size:12px; font-weight:800; letter-spacing:.2px; margin:12px 0 6px;}
    .analysis ul{margin:6px 0 0 16px; padding:0}
    .analysis li{margin:6px 0; font-size:12px; line-height:1.45}
    .footnote{color:var(--muted); font-size:11px; margin-top:8px}
    .badge{
      display:inline-flex; align-items:center; gap:6px;
      padding:4px 8px; border-radius:999px;
      border:1px solid var(--border); color:var(--muted); font-size:11px;
    }
    .dot{width:8px; height:8px; border-radius:999px; background:var(--muted)}
    .dot.ok{background:var(--good)}
    .dot.warn{background:var(--warn)}
    .dot.bad{background:var(--bad)}
  </style>
</head>
<body>
  <header>
    <div class="left">
      <h1>ğŸ¤– Ops Copilot Console</h1>
      <div class="sub">AI-first è¿ç»´æŒ‡æŒ¥ä¸­å¿ƒï¼ˆç»“è®ºä¸ºä¸»ï¼Œè¯æ®ä¸ºè¾…ï¼‰</div>
    </div>
    <div class="right">
      <div class="pill">API: <b id="apiBaseText"></b></div>
      <div class="pill">çŠ¶æ€: <b id="apiStatus">æœªçŸ¥</b></div>
      <button class="btn" id="btnRefresh">åˆ·æ–°</button>
    </div>
  </header>

  <main>
    <!-- LEFT: Copilot + Focus + Timeline -->
    <div class="card">
      <div class="hd">
        <div class="title">A Â· Ops Copilotï¼ˆä¸»è§†è§’ï¼‰</div>
        <div class="kpi">
          <span class="badge"><span class="dot" id="dotHealth"></span><span id="healthText">Health</span></span>
          <span class="badge">é€‰ä¸­äº‹ä»¶: <span id="selectedEventText" class="mono">æ— </span></span>
        </div>
      </div>
      <div class="bd">
        <div class="grid2">
          <!-- Chat -->
          <div class="stack">
            <div class="msgbox">
              <div class="row" style="justify-content:space-between;">
                <div class="small"><b>Copilot Briefing</b> <span class="muted">ï¼ˆæ¼”ç¤ºç”¨å›ºå®šé—®é¢˜æŒ‰é’®ï¼‰</span></div>
                <div class="tag">ç»“æ„åŒ–è¾“å‡º</div>
              </div>

              <div class="quick" style="margin-top:10px;">
                <button class="btn" data-q="ç°åœ¨ç³»ç»ŸçŠ¶æ€æ€ä¹ˆæ ·ï¼Ÿ">ç°åœ¨çŠ¶æ€ï¼Ÿ</button>
                <button class="btn" data-q="å‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿä¸ºä»€ä¹ˆè¿™æ˜¯ä¸ªé—®é¢˜ï¼Ÿ">å‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿ</button>
                <button class="btn" data-q="ä¼šä¸ä¼šå½±å“ä¸šåŠ¡ï¼Ÿè¦ä¸è¦é©¬ä¸Šå¤„ç†ï¼Ÿ">å½±å“/ç´§æ€¥ï¼Ÿ</button>
                <button class="btn" data-q="æˆ‘ç°åœ¨åº”è¯¥åšä»€ä¹ˆï¼ŸæŒ‰ä¼˜å…ˆçº§ç»™æ­¥éª¤ã€‚">ä¸‹ä¸€æ­¥æ€ä¹ˆåšï¼Ÿ</button>
                <button class="btn" data-q="å¦‚æœæˆ‘æš‚æ—¶ä¸å¤„ç†ï¼Œä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ">ä¸å¤„ç†ä¼šæ€æ ·ï¼Ÿ</button>
              </div>

              <div class="sep"></div>

              <div id="chat" class="chat"></div>

              <div class="inputrow">
                <input id="chatInput" type="text" placeholder="è¾“å…¥ä¸€å¥è¯ï¼Œä¾‹å¦‚ï¼šç°åœ¨ç³»ç»ŸçŠ¶æ€æ€ä¹ˆæ ·ï¼Ÿ" />
                <button class="btn" id="btnSend">å‘é€</button>
              </div>

              <div class="footnote">
                Tipï¼šç‚¹ä¸Šé¢æŒ‰é’®èƒ½ä¿è¯æ¯æ¬¡æ¼”ç¤ºéƒ½ç¨³ï¼ˆä¸ä¼šé çµæ„Ÿï¼‰ã€‚
              </div>
            </div>
          </div>

          <!-- Focus + Timeline -->
          <div class="stack">
            <div class="card" style="margin:0;">
              <div class="hd">
                <div class="title">C Â· å…³æ³¨ç„¦ç‚¹ï¼ˆTop 3ï¼‰</div>
                <div class="muted tiny">â€œä½ ç°åœ¨æœ€è¯¥å…³å¿ƒçš„â€</div>
              </div>
              <div class="bd">
                <div id="focusList" class="list"></div>
              </div>
            </div>

            <div class="card" style="margin:0;">
              <div class="hd">
                <div class="title">B Â· äº‹ä»¶æ—¶é—´çº¿ï¼ˆNarrativeï¼‰</div>
                <div class="muted tiny">â€œAI å¦‚ä½•ç†è§£äº‹ä»¶â€</div>
              </div>
              <div class="bd">
                <div id="timeline" class="timeline"></div>
                <div class="footnote">é€‰ä¸­æŸä¸ªäº‹ä»¶åè‡ªåŠ¨åˆ·æ–°ã€‚</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- RIGHT: Analysis + Evidence -->
    <div class="rightcol">
      <div class="card analysis">
        <div class="hd">
          <div class="title">AI åˆ†æé¢æ¿ï¼ˆç»“è®º â†’ é£é™© â†’ æ ¹å›  â†’ åŠ¨ä½œï¼‰</div>
          <div id="riskBadge"></div>
        </div>
        <div class="bd">
          <div class="summary" id="summaryText" class="small muted">æš‚æ— åˆ†æã€‚å…ˆç‚¹ä¸€ä¸ªäº‹ä»¶æˆ–åœ¨ Copilot é—®ä¸€å¥ã€‚</div>

          <div class="secTitle">é£é™©è¯„ä¼°</div>
          <div id="riskText" class="small muted">-</div>

          <div class="secTitle">å¯èƒ½åŸå› </div>
          <ul id="causes"></ul>

          <div class="secTitle">å»ºè®®åŠ¨ä½œ</div>
          <ul id="actions"></ul>

          <div class="secTitle">è¯æ®å¼•ç”¨</div>
          <div id="evidenceRefs" class="tiny muted">-</div>
        </div>
      </div>

      <div class="card">
        <div class="hd">
          <div class="title">è¯æ®å±‚ï¼ˆäº‹ä»¶/æ—¥å¿—æµï¼‰</div>
          <div class="muted tiny">â€œæ•°æ®ç»™ AI ç”¨ï¼Œäººåªåœ¨éœ€è¦æ—¶çœ‹è¯æ®â€</div>
        </div>
        <div class="bd">
          <div class="row" style="justify-content:space-between;">
            <div class="small"><b>æœ€æ–°äº‹ä»¶ï¼ˆç”¨äºçœŸå®æ„Ÿï¼‰</b></div>
            <div class="tag mono" id="eventCount">0</div>
          </div>
          <div class="sep"></div>
          <div id="logbox" class="logbox"></div>
          <div class="footnote">é»˜è®¤æ¯ 2 ç§’åˆ·æ–°ä¸€æ¬¡ï¼ˆå¯æ”¹ï¼‰ã€‚</div>
        </div>
      </div>
    </div>
  </main>

<script>
(() => {
  // === Config ===
  const API_BASE = localStorage.getItem("OPS_API_BASE") || "http://127.0.0.1:8000";
  const REFRESH_MS = 2000;

  // === DOM ===
  const apiBaseText = document.getElementById("apiBaseText");
  const apiStatus = document.getElementById("apiStatus");
  const btnRefresh = document.getElementById("btnRefresh");
  const dotHealth = document.getElementById("dotHealth");
  const healthText = document.getElementById("healthText");
  const selectedEventText = document.getElementById("selectedEventText");

  const chat = document.getElementById("chat");
  const chatInput = document.getElementById("chatInput");
  const btnSend = document.getElementById("btnSend");

  const focusList = document.getElementById("focusList");
  const timeline = document.getElementById("timeline");

  const riskBadge = document.getElementById("riskBadge");
  const summaryText = document.getElementById("summaryText");
  const riskText = document.getElementById("riskText");
  const causes = document.getElementById("causes");
  const actions = document.getElementById("actions");
  const evidenceRefs = document.getElementById("evidenceRefs");

  const logbox = document.getElementById("logbox");
  const eventCount = document.getElementById("eventCount");

  apiBaseText.textContent = API_BASE;

  // === State ===
  let selectedEventId = null;
  let lastEvents = [];

  // === Helpers ===
  const $ = (sel) => document.querySelector(sel);

  function lvlClass(lvl){
    if(!lvl) return "low";
    const x = String(lvl).toUpperCase();
    if(x === "HIGH") return "high";
    if(x === "MEDIUM") return "med";
    return "low";
  }

  function lvlLabel(lvl){
    const x = String(lvl||"LOW").toUpperCase();
    if(x === "HIGH") return "HIGH";
    if(x === "MEDIUM") return "MEDIUM";
    return "LOW";
  }

  function setHealth(ok, text){
    apiStatus.textContent = ok ? "OK" : "DOWN";
    dotHealth.className = "dot " + (ok ? "ok" : "bad");
    healthText.textContent = text || (ok ? "Healthy" : "Unreachable");
  }

  async function api(path, opts={}){
    const url = API_BASE + path;
    const res = await fetch(url, {
      headers: {"Content-Type":"application/json"},
      ...opts
    });
    if(!res.ok){
      const t = await res.text().catch(()=> "");
      throw new Error(`HTTP ${res.status} ${path} ${t}`);
    }
    return res.json();
  }

  function pushBubble(text, who="ai"){
    const div = document.createElement("div");
    div.className = "bubble " + (who === "me" ? "me" : "ai");
    div.textContent = text;
    chat.appendChild(div);
    chat.scrollTop = chat.scrollHeight;
  }

  function renderFocus(items){
    focusList.innerHTML = "";
    if(!items || items.length === 0){
      focusList.innerHTML = `<div class="muted small">æš‚æ— äº‹ä»¶ã€‚å…ˆè·‘ mock_feeder æˆ–æ‰‹åŠ¨ ingestã€‚</div>`;
      return;
    }
    for(const it of items){
      const div = document.createElement("div");
      div.className = "item" + (it.event_id === selectedEventId ? " sel" : "");
      div.innerHTML = `
        <div class="top">
          <div class="t">${escapeHtml(it.title)}</div>
          <span class="lvl ${lvlClass(it.risk_level)}">${lvlLabel(it.risk_level)}</span>
        </div>
        <div class="muted tiny" style="margin-top:6px;">${escapeHtml(it.one_line || "")}</div>
        <div class="muted tiny mono" style="margin-top:6px;">${escapeHtml(it.event_id)}</div>
      `;
      div.onclick = () => selectEvent(it.event_id);
      focusList.appendChild(div);
    }
  }

  function renderTimeline(items){
    timeline.innerHTML = "";
    if(!items || items.length === 0){
      timeline.innerHTML = `<div class="muted small">æš‚æ— æ—¶é—´çº¿ã€‚è¯·å…ˆé€‰ä¸­äº‹ä»¶ã€‚</div>`;
      return;
    }
    for(const t of items){
      const div = document.createElement("div");
      div.className = "tl";
      div.innerHTML = `
        <div class="ts mono">${escapeHtml(t.ts)}</div>
        <div class="note">${escapeHtml(t.note)}</div>
      `;
      timeline.appendChild(div);
    }
    timeline.scrollTop = timeline.scrollHeight;
  }

  function renderAnalysis(a){
    if(!a){
      riskBadge.innerHTML = "";
      summaryText.textContent = "æš‚æ— åˆ†æã€‚å…ˆç‚¹ä¸€ä¸ªäº‹ä»¶æˆ–åœ¨ Copilot é—®ä¸€å¥ã€‚";
      riskText.textContent = "-";
      causes.innerHTML = "";
      actions.innerHTML = "";
      evidenceRefs.textContent = "-";
      return;
    }
    const lvl = a.risk?.level || "LOW";
    riskBadge.innerHTML = `<span class="lvl ${lvlClass(lvl)}">${lvlLabel(lvl)}</span>`;
    summaryText.textContent = a.summary || "";
    riskText.textContent = `${lvlLabel(lvl)} Â· ç½®ä¿¡åº¦ ${(a.risk?.confidence ?? 0).toFixed(2)} Â· å½±å“ï¼š${a.risk?.impact || "-"} Â· æ‰©æ•£ï¼š${a.risk?.spread || "-"}`;

    causes.innerHTML = "";
    (a.possible_causes || []).forEach(c => {
      const li = document.createElement("li");
      li.textContent = `${c.rank}. ${c.cause}ï¼ˆ${(c.confidence ?? 0).toFixed(2)}ï¼‰`;
      causes.appendChild(li);
    });

    actions.innerHTML = "";
    (a.actions || []).forEach(x => {
      const li = document.createElement("li");
      li.textContent = `${x.priority}. ${x.action} â€”â€” ${x.why}`;
      actions.appendChild(li);
    });

    const refs = (a.evidence_refs || []).map(r => {
      if(r.type === "log") return `log:${r.id || "-"}`;
      return `metric:${r.name || "-"}@${r.ts || "-"}`;
    });
    evidenceRefs.textContent = refs.length ? refs.join(" Â· ") : "-";
  }

  function renderLogBox(events){
    logbox.innerHTML = "";
    eventCount.textContent = String(events.length);
    for(const e of events){
      const raw = e?.evidence?.logs?.[0]?.raw || "";
      const ts = e.ts || "";
      const sev = e.severity_hint || "INFO";
      const line = document.createElement("div");
      line.className = "logline";
      line.innerHTML = `<span class="ts">${escapeHtml(ts)}</span>  <span class="sev${escapeHtml(sev)}">${escapeHtml(sev)}</span>  ${escapeHtml(raw || e.title || "")}`;
      logbox.appendChild(line);
    }
  }

  function escapeHtml(s){
    return String(s ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  async function selectEvent(eventId){
    selectedEventId = eventId;
    selectedEventText.textContent = eventId ? eventId : "æ— ";

    // åˆ·æ–° timeline
    try{
      const tl = await api(`/api/incidents/${encodeURIComponent(eventId)}/timeline`);
      renderTimeline(tl.timeline || []);
    }catch(e){
      renderTimeline([]);
    }

    // é»˜è®¤æ¥ä¸€ä»½ â€œwhat_happenedâ€ åˆ†æ
    try{
      const a = await api(`/api/copilot/analyze`, {
        method:"POST",
        body: JSON.stringify({ event_id: eventId, question:"what_happened", context:{} })
      });
      renderAnalysis(a);
    }catch(e){
      renderAnalysis(null);
    }

    // åˆ·æ–° focus é«˜äº®
    await refreshFocus();
  }

  async function refreshHealth(){
    try{
      const h = await api("/api/health");
      setHealth(true, `LLM:${h.llm} v${h.version}`);
    }catch(e){
      setHealth(false, "API unreachable");
    }
  }

  async function refreshFocus(){
    try{
      const f = await api("/api/focus?top=3");
      renderFocus(f.items || []);
      // æ²¡é€‰ä¸­æ—¶ï¼šé»˜è®¤é€‰ top1
      if(!selectedEventId && f.items && f.items.length){
        await selectEvent(f.items[0].event_id);
      }
    }catch(e){
      renderFocus([]);
    }
  }

  async function refreshEvents(){
    try{
      const evts = await api("/api/events?limit=30");
      lastEvents = evts || [];
      renderLogBox(lastEvents);
    }catch(e){
      renderLogBox([]);
    }
  }

  async function sendChat(text){
    const msg = text.trim();
    if(!msg) return;
    pushBubble(msg, "me");

    try{
      const payload = {
        session_id: "demo",
        message: msg,
        context: { selected_event_id: selectedEventId }
      };
      const r = await api("/api/copilot/chat", { method:"POST", body: JSON.stringify(payload) });

      pushBubble(r.reply || "(no reply)", "ai");
      // æ›´æ–° focusï¼ˆAI è¯´å®Œé¡ºä¾¿åˆ·æ–°ä¸€ä¸‹ï¼‰
      await refreshFocus();

      // è‹¥è¿”å› analysisï¼Œåˆ™æ›´æ–°å³ä¾§é¢æ¿
      if(r.analysis) renderAnalysis(r.analysis);

      // è‹¥ focus åˆ—è¡¨å˜åŒ–åé€‰ä¸­çš„äº‹ä»¶ä¸¢äº†ï¼Œä¹Ÿæ²¡å…³ç³»
    }catch(e){
      pushBubble("è°ƒç”¨ Copilot å¤±è´¥ï¼šè¯·ç¡®è®¤åç«¯å·²å¯åŠ¨ï¼Œå¹¶å…è®¸ CORSã€‚", "ai");
    }
  }

  // === Wiring ===
  btnSend.onclick = () => { sendChat(chatInput.value); chatInput.value=""; chatInput.focus(); };
  chatInput.addEventListener("keydown", (e) => {
    if(e.key === "Enter"){ btnSend.click(); }
  });

  document.querySelectorAll("[data-q]").forEach(btn => {
    btn.onclick = () => sendChat(btn.getAttribute("data-q"));
  });

  btnRefresh.onclick = async () => {
    await refreshAll(true);
  };

  async function refreshAll(force=false){
    await refreshHealth();
    await refreshEvents();
    await refreshFocus();
  }

  // === Init ===
  (async () => {
    pushBubble("æˆ‘å·²ç»å¸®ä½ çœ‹å®Œç³»ç»Ÿäº†ã€‚ä½ å¯ä»¥ç‚¹ä¸Šé¢çš„æŒ‰é’®å¼€å§‹æ¼”ç¤ºã€‚", "ai");
    await refreshAll(true);
    setInterval(() => refreshAll(false), REFRESH_MS);
  })();
})();
</script>
<script>
/* ========= Copilot è‡ªç”±æ¨¡å¼ä¿æŠ¤ ========= */

function isNonsense(text) {
  const t = (text || "").trim();
  if (t.length < 6) return true;

  // å¸¸è§æ— æ„ä¹‰è¾“å…¥
  const bad = /^(å“ˆ+|å“ˆå“ˆ+|å—¯+|å“¦+|é¢+|â€¦+|\?+|ï¼Ÿ+|ä½ è¿˜|ok|å¥½çš„)$/i;
  return bad.test(t);
}

async function sendCopilotQuestion() {
  const input = document.getElementById("copilot-input");
  const question = input.value.trim();

  if (isNonsense(question)) {
    appendCopilotMessage("è¯·è¾“å…¥æ›´å…·ä½“çš„é—®é¢˜ï¼Œä¾‹å¦‚ï¼š\nâ€¢ ç°åœ¨æœ‰å“ªäº›é«˜é£é™©äº‹ä»¶ï¼Ÿ\nâ€¢ å¦‚æœæˆ‘æš‚æ—¶ä¸å¤„ç†ï¼Œä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ", "system");
    return;
  }

  appendCopilotMessage(question, "user");
  input.value = "";

  try {
    const resp = await fetch("/api/copilot/ask", {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({
        question: question,
        top: 3
      })
    });

    const data = await resp.json();

    if (!data.ok) {
      appendCopilotMessage("Copilot å‡ºé”™ï¼š" + data.error, "system");
      return;
    }

    renderCopilotResult(data);

  } catch (e) {
    appendCopilotMessage("æ— æ³•è¿æ¥ Copilot æœåŠ¡", "system");
  }
}

/* ========= æ¸²æŸ“ç»“æ„åŒ–ç»“æœ ========= */

function renderCopilotResult(data) {
  const r = data.result || {};
  const lines = [];

  if (r.overall && r.overall.summary) {
    lines.push("ã€æ•´ä½“çŠ¶æ€ã€‘");
    lines.push(r.overall.summary);
    lines.push("");
  }

  if (Array.isArray(r.top)) {
    r.top.forEach((e, i) => {
      lines.push(`ã€äº‹ä»¶ ${i + 1}ã€‘${e.title}`);
      if (e.count) lines.push(`å‘ç”Ÿæ¬¡æ•°ï¼š${e.count}`);
      if (e.why_it_matters) lines.push(`å½±å“ï¼š${e.why_it_matters}`);
      if (Array.isArray(e.next_steps)) {
        lines.push("å»ºè®®ä¸‹ä¸€æ­¥ï¼š");
        e.next_steps.forEach(s => lines.push("â€¢ " + s));
      }
      lines.push("");
    });
  }

  appendCopilotMessage(lines.join("\n"), "assistant");
}

/* ========= ç®€å•å¯¹è¯æ¸²æŸ“ï¼ˆä½ åŸæœ¬åº”è¯¥å·²ç»æœ‰ç±»ä¼¼çš„ï¼‰ ========= */

function appendCopilotMessage(text, role) {
  const box = document.getElementById("copilot-chat");
  const div = document.createElement("div");
  div.className = "msg " + role;
  div.innerText = text;
  box.appendChild(div);
  box.scrollTop = box.scrollHeight;
}
</script>
</body>
</html>
